name: Build Chrome Bundle

on:
  schedule:
    - cron: '0 6 * * *' # ⏰ Runs daily at 06:00 UTC to check for new releases
  workflow_dispatch: # 🔘 Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 🔧 Configure APT and install required tools
        run: |
          # Ensure we have all repositories enabled
          sudo add-apt-repository main
          sudo add-apt-repository universe
          sudo add-apt-repository multiverse
          sudo add-apt-repository restricted

          # Update package lists
          sudo apt-get update

          # Install required tools
          sudo apt-get install -y wget curl unzip dpkg-dev apt-utils software-properties-common

      - name: 🔍 Get latest stable Chrome version
        id: chrome
        run: |
          latest=$(curl -s https://dl.google.com/linux/chrome/deb/dists/stable/main/binary-amd64/Packages | \
            grep -A1 "Package: google-chrome-stable" | grep "Version:" | head -n1 | awk '{print $2}')
          echo "Latest Chrome version: $latest"
          echo "version=$latest" >> $GITHUB_OUTPUT

      - name: 📥 Download latest Chrome Linux build
        run: |
          mkdir -p chrome-linux
          cd chrome-linux
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          dpkg-deb -x google-chrome-stable_current_amd64.deb .
          mv opt/google/chrome/* .
          rm -rf opt usr google-chrome-stable_current_amd64.deb

      - name: 📥 Download dependencies with improved method
        run: |
          # First, ensure all required packages are installed on the system
          # Handle both old package names and new t64 variants
          echo "📦 Installing required packages on system..."

          # Install packages - trying both old and t64 variants where applicable
          for pkg in libatk1.0-0 libatk-bridge2.0-0 libcups2 libgbm1 \
                     libgtk-3-0 libasound2 libnss3 libxshmfence1 \
                     libdrm2 libdbus-1-3 libglib2.0-0 libgdk-pixbuf-2.0-0 \
                     libpango-1.0-0 libpangocairo-1.0-0 libcurl4 \
                     libxcomposite1 libxdamage1 libxrandr2 libx11-6 \
                     libxext6 libexpat1 libxi6 libxrender1 libcairo2 \
                     libudev1 libpcre3 libxcb1 libxkbcommon0 \
                     libatspi2.0-0 libavahi-common3 libavahi-client3; do
            # Try regular package name first
            sudo apt-get install -y "$pkg" 2>/dev/null || \
            # If that fails, try with t64 suffix
            sudo apt-get install -y "${pkg}t64" 2>/dev/null || \
            # If both fail, that's okay - package might not exist or have different name
            true
          done

          # Make script executable
          chmod +x ./scripts/fetch-libs.sh

          # Run the script (it will now be able to access installed packages)
          sudo ./scripts/fetch-libs.sh

          # Verify we have libraries
          lib_count=$(find chrome-linux/lib -name "*.so*" 2>/dev/null | wc -l)
          echo "📊 Found $lib_count library files in chrome-linux/lib"

          if [ "$lib_count" -lt 10 ]; then
            echo "❌ ERROR: Too few libraries collected (only $lib_count)"
            echo "📋 Attempting emergency fallback..."
            
            mkdir -p chrome-linux/lib
            
            # Direct copy from system as last resort
            for dir in /usr/lib/x86_64-linux-gnu /lib/x86_64-linux-gnu; do
              if [ -d "$dir" ]; then
                echo "Copying from $dir..."
                find "$dir" -maxdepth 1 -name "*.so*" -type f | while read -r lib; do
                  cp -L "$lib" chrome-linux/lib/ 2>/dev/null || true
                done
              fi
            done
            
            lib_count=$(find chrome-linux/lib -name "*.so*" 2>/dev/null | wc -l)
            echo "📊 After fallback: $lib_count library files"
          fi

      - name: 🔍 List Chrome dependencies (for debugging)
        run: |
          echo "Chrome binary dependencies:"
          ldd chrome-linux/chrome | head -20 || true
          echo "..."
          echo "Library directory contents:"
          ls -la chrome-linux/lib/ | head -20 || echo "No lib directory found"

      - name: 📦 Create zip archive
        run: |
          # Create a README
          cat > chrome-linux/README.md << 'EOF'
          # Chrome Linux Bundle

          This bundle includes Chrome and its required shared libraries.

          ## Usage

          Run Chrome using the wrapper script:
          ```bash
          ./run-chrome.sh
          ```

          Or manually with LD_LIBRARY_PATH:
          ```bash
          LD_LIBRARY_PATH=./lib:$LD_LIBRARY_PATH ./chrome
          ```
          EOF

          # Create the archive
          zip -r chrome-linux-${{ steps.chrome.outputs.version }}.zip chrome-linux

      - name: 🚀 Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.chrome.outputs.version }}
          name: Chrome ${{ steps.chrome.outputs.version }}
          body: |
            Automatic build of Chrome Linux bundle with required shared libraries.

            ## What's included
            - Chrome browser binary (version ${{ steps.chrome.outputs.version }})
            - All required shared libraries in `lib/` directory
            - `run-chrome.sh` wrapper script for easy launching

            ## Usage
            1. Extract the zip file
            2. Run `./chrome-linux/run-chrome.sh`
          files: chrome-linux-${{ steps.chrome.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
