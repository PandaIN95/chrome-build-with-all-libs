name: Build Chrome Bundle

on:
  schedule:
    - cron: '0 6 * * *' # ⏰ Runs daily at 06:00 UTC
  workflow_dispatch: # 🔘 Allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 📦 Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip dpkg-dev apt-utils

      - name: 🔍 Get latest stable Chrome version
        id: chrome
        run: |
          full_version=$(curl -s https://dl.google.com/linux/chrome/deb/dists/stable/main/binary-amd64/Packages | \
            grep -A1 "Package: google-chrome-stable" | grep "Version:" | head -n1 | awk '{print $2}')

          major_version=$(echo $full_version | cut -d'.' -f1)

          echo "Full version: $full_version"
          echo "Major version: $major_version"

          echo "full_version=$full_version" >> $GITHUB_OUTPUT
          echo "major_version=$major_version" >> $GITHUB_OUTPUT

      - name: 🛑 Check if major release already exists
        id: check_release
        run: |
          if gh release view v${{ steps.chrome.outputs.major_version }} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📥 Download latest Chrome Linux build
        if: steps.check_release.outputs.exists == 'false'
        run: |
          mkdir -p chrome-linux
          cd chrome-linux
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          dpkg-deb -x google-chrome-stable_current_amd64.deb .
          mv opt/google/chrome/* .
          rm -rf opt usr google-chrome-stable_current_amd64.deb

      - name: 📥 Download dependencies
        if: steps.check_release.outputs.exists == 'false'
        run: |
          chmod +x ./scripts/fetch-libs.sh
          ./scripts/fetch-libs.sh

      - name: 📦 Create tar.gz archive
        if: steps.check_release.outputs.exists == 'false'
        run: |
          tar -czf chrome-linux-${{ steps.chrome.outputs.full_version }}.tar.gz chrome-linux

      - name: 🚀 Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.chrome.outputs.major_version }}
          name: Chrome ${{ steps.chrome.outputs.major_version }}
          body: "Automatic build of Chrome Linux bundle (first release for major version ${{ steps.chrome.outputs.major_version }})\n\nFull version: ${{ steps.chrome.outputs.full_version }}"
          files: chrome-linux-${{ steps.chrome.outputs.full_version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
